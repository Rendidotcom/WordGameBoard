import { initBoard } from './components/board.js';
import { updateScoreBoard } from './components/scoreBoard.js';
import { supabase } from './supabaseClient.js';

const authDiv = document.getElementById('auth');
const gameDiv = document.getElementById('game');
const uname = document.getElementById('user-name');
const upoints = document.getElementById('user-points');
const wlist = document.getElementById('word-list');
const wordInput = document.getElementById('word-input');

let currentUser = null;

async function register() {
  const username = document.getElementById('reg-username').value;
  const email = document.getElementById('reg-email').value;
  const password = document.getElementById('reg-pass').value;

  if (!username || !email || !password) {
    alert('All fields are required!');
    return;
  }

  const { data, error } = await supabase.auth.signUp({ email, password });

  if (error) {
    alert(error.message);
    return;
  }

  const userId = data.user?.id ?? data.session?.user.id;

  if (!userId) {
    alert('User ID not found after registration.');
    return;
  }

  const { error: insertError } = await supabase
    .from('ProfileScores')
    .insert([{ id: userId, username, points: 0 }]);

  if (insertError) {
    alert('Failed to save user profile: ' + insertError.message);
    return;
  }

  alert('Registration successful! Please log in.');
}

async function login() {
  const email = document.getElementById('log-email').value;
  const password = document.getElementById('log-pass').value;

  if (!email || !password) {
    alert('Both email and password are required!');
    return;
  }

  const { data, error } = await supabase.auth.signInWithPassword({ email, password });

  if (error) {
    alert(error.message);
    return;
  }

  const userId = data.user?.id;

  const { data: profile, error: profileError } = await supabase
    .from('ProfileScores')
    .select('*')
    .eq('id', userId)
    .single();

  if (profileError) {
    alert('Failed to load profile: ' + profileError.message);
    return;
  }

  currentUser = profile;
  startGame();
}

function startGame() {
  authDiv.classList.add('hidden');
  gameDiv.classList.remove('hidden');
  uname.textContent = currentUser.username;
  upoints.textContent = currentUser.points;
  initBoard('board-container');
}

async function validateWord(word) {
  const response = await fetch(`https://api.dictionaryapi.dev/api/v2/entries/en/${word}`);
  return response.ok;
}

async function updateScore() {
  if (!currentUser) return;

  const word = wordInput.value.trim();
  if (!word) return alert('Please enter a word');

  const isValid = await validateWord(word);
  if (!isValid) return alert('Invalid word!');

  const points = word.length;

  const { error } = await supabase
    .from('ProfileScores')
    .update({ points: currentUser.points + points })
    .eq('id', currentUser.id);

  if (error) {
    alert('Failed to update score: ' + error.message);
    return;
  }

  currentUser.points += points;
  updateScoreBoard(currentUser.username, currentUser.points);

  const li = document.createElement('li');
  li.textContent = `Word: ${word} | +${points} Points`;
  wlist.appendChild(li);
  wordInput.value = '';
}

document.getElementById('btn-register').addEventListener('click', register);
document.getElementById('btn-login').addEventListener('click', login);
document.getElementById('btn-submit').addEventListener('click', updateScore);
